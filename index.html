<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Trò chơi Mạo Hiểm: Nhảy Vượt Chướng Ngại Vật - Hai Webcam</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background: #eee;
      margin: 0;
      padding: 20px;
    }
    h1 {
      margin-bottom: 10px;
    }
    #score {
      font-size: 24px;
      margin-bottom: 20px;
    }
    #gameContainer {
      position: relative;
      margin: auto;
    }
    canvas {
      border: 1px solid black;
      display: block;
      margin: 0 auto 20px auto;
    }
    #webcamContainer {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 20px auto;
    }
    .webcamWrapper {
      position: relative;
    }
    .webcamWrapper video {
      border: 1px solid black;
    }
    .webcamWrapper canvas {
      position: absolute;
      top: 0;
      left: 0;
      pointer-events: none;
    }
    #startButton {
      font-size: 24px;
      padding: 10px 20px;
      cursor: pointer;
      margin-top: 20px;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: 'Roboto', sans-serif;
      background: url("https://i.gifer.com/J4o.gif") no-repeat center center fixed;
      background-size: cover;
      color: #fff;
    }
    .container {
      max-width: 1200px;
      margin: 30px auto;
      padding: 20px;
      text-align: center;
      background: rgba(0, 0, 0, 0.6);
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    }
    h1 {
      font-size: 2.8em;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
    }
    #score {
      font-size: 1.8em;
      margin-bottom: 20px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
    }
    #gameContainer {
      margin: 20px auto;
      position: relative;
    }
    #gameCanvas {
      background: rgba(255, 255, 255, 0.8);
      border: 2px solid #fff;
      border-radius: 10px;
    }
    #startButton {
      padding: 12px 30px;
      font-size: 1.2em;
      background: #ff5722;
      border: none;
      border-radius: 5px;
      color: #fff;
      cursor: pointer;
      margin: 20px 0;
      box-shadow: 2px 2px 4px rgba(0,0,0,0.5);
      transition: background 0.3s;
    }
    #startButton:hover { background: #e64a19; }
    #instructions {
      font-size: 1.2em;
      margin-bottom: 20px;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
    }
    #webcamContainer {
      display: flex;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;
      margin: 20px auto;
    }
    .webcamWrapper {
      position: relative;
      width: 320px;
      height: 240px;
      border: 2px solid #fff;
      border-radius: 10px;
      overflow: hidden;
    }
    .webcamWrapper video,
    .webcamWrapper canvas {
      width: 100%;
      height: 100%;
      border-radius: 10px;
    }
    #leaderboard {
      margin-top: 20px;
      font-size: 20px;
      background: rgba(255, 255, 255, 0.8);
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    }
    #leaderboard h2 {
      margin-bottom: 10px;
      color: #ff5722;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
    }
    #leaderboard ol {
      list-style: none;
      padding: 0;
    }
    #leaderboard li {
      margin: 8px 0;
      font-size: 18px;
      color: #333;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Trò chơi Mạo Hiểm: Nhảy Vượt Chướng Ngại Vật</h1>
    <div id="score">Điểm: 0</div>
    <div id="gameContainer">
      <canvas id="gameCanvas" width="800" height="400"></canvas>
    </div>
    <button id="startButton">Bắt đầu chơi</button>
    <p id="instructions">Hãy nhảy thật cao trước webcam để giúp người mạo hiểm nhảy qua chướng ngại vật!</p>
    <div id="webcamContainer">
      <div class="webcamWrapper">
        <video id="webcam1" width="320" height="240" autoplay playsinline></video>
        <canvas id="overlay1" width="320" height="240"></canvas>
      </div>
      <div class="webcamWrapper">
        <video id="webcam2" width="320" height="240" autoplay playsinline></video>
        <canvas id="overlay2" width="320" height="240"></canvas>
      </div>
    </div>
    <div id="leaderboard">
      <h2>Bảng Xếp Hạng</h2>
      <ol id="leaderboardList"></ol>
    </div>
  </div>

  <!-- Tải TensorFlow.js và PoseNet -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/posenet@latest"></script>
  <script>
    /***********************
     * Phần nhận diện nhảy *
     ***********************/
    const video1 = document.getElementById('webcam1');
    const overlay1 = document.getElementById('overlay1');
    const poseCtx1 = overlay1.getContext('2d');
    let posenetModel;
    let baselineFaceY = null;  // Giá trị cơ sở của vị trí top của face box
    const thresholdFace = 15;    // Ngưỡng so sánh (pixel) cho khuôn mặt
    let isJumpingDetection = false;  // flag để tránh kích hoạt nhiều lần
    let jumpSignal = false; // Tín hiệu nhảy được set thành true khi phát hiện nhảy

    async function setupWebcams() {
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      video1.srcObject = stream;
      const video2 = document.getElementById('webcam2');
      video2.srcObject = stream.clone();
      return new Promise(resolve => {
        video1.onloadedmetadata = () => {
          video1.play();
          video2.play();
          resolve();
        };
      });
    }

    async function loadPoseNet() {
      posenetModel = await posenet.load();
    }

    async function detectPose() {
      const pose = await posenetModel.estimateSinglePose(video1, { flipHorizontal: false });
      poseCtx1.clearRect(0, 0, overlay1.width, overlay1.height);
      
      const keypoints = pose.keypoints.filter(k => k.score > 0.5);
      if (keypoints.length > 0) {
        const xs = keypoints.map(k => k.position.x);
        const ys = keypoints.map(k => k.position.y);
        const minX = Math.min(...xs);
        const minY = Math.min(...ys);
        const maxX = Math.max(...xs);
        const maxY = Math.max(...ys);
        poseCtx1.strokeStyle = "green";
        poseCtx1.lineWidth = 2;
        poseCtx1.strokeRect(minX, minY, maxX - minX, maxY - minY);
        keypoints.forEach(k => {
          poseCtx1.fillStyle = "red";
          poseCtx1.fillRect(k.position.x - 3, k.position.y - 3, 6, 6);
        });
      }
      
      const faceParts = ['nose', 'leftEye', 'rightEye', 'leftEar', 'rightEar'];
      const faceKeypoints = pose.keypoints.filter(k => faceParts.includes(k.part) && k.score > 0.5);
      if (faceKeypoints.length > 0) {
        const faceXs = faceKeypoints.map(k => k.position.x);
        const faceYs = faceKeypoints.map(k => k.position.y);
        const faceMinX = Math.min(...faceXs);
        const faceMinY = Math.min(...faceYs);
        const faceMaxX = Math.max(...faceXs);
        const faceMaxY = Math.max(...faceYs);
        const faceWidth = faceMaxX - faceMinX;
        const faceHeight = faceMaxY - faceMinY;
        poseCtx1.strokeStyle = "red";
        poseCtx1.lineWidth = 3;
        poseCtx1.strokeRect(faceMinX, faceMinY, faceWidth, faceHeight);
        
        if (baselineFaceY === null) {
          baselineFaceY = faceMinY;
        } else if (!isJumpingDetection) {
          baselineFaceY = baselineFaceY * 0.9 + faceMinY * 0.1;
        }
        if (faceMinY < baselineFaceY - thresholdFace && !isJumpingDetection) {
          isJumpingDetection = true;
          jumpSignal = true;
          setTimeout(() => { isJumpingDetection = false; }, 1000);
        }
      }
      requestAnimationFrame(detectPose);
    }

    async function initPoseDetection() {
      await setupWebcams();
      await loadPoseNet();
      detectPose();
    }

    initPoseDetection();

    /***********************
     * Phần trò chơi game *
     ***********************/
    const robotImg = new Image();
    robotImg.src = "https://em-content.zobj.net/thumbs/120/apple/325/robot_1f916.png"; // Hình ảnh robot
    const treeImg = new Image();
    treeImg.src = "https://em-content.zobj.net/thumbs/120/apple/325/rocket_1f680.png"; // Hình ảnh cây thông

    const gameCanvas = document.getElementById('gameCanvas');
    const gameCtx = gameCanvas.getContext('2d');
    const groundY = 350; // Mức đất
    let gameScore = 0;
    let gameOver = false;
    let jumpTextVisible = false; // Hiển thị chữ "NHAY" khi nhảy
    let lastJumpTime = 0; // Thời gian nhảy cuối cùng
    let jumpEffect = false; // Hiệu ứng nhảy

    const hero = {
      x: 100,
      y: groundY,
      width: 50,
      height: 50,
      jumpForce: -10,  // Lực nhảy cơ bản
      vy: 0
    };

    let obstacles = [];

    function updateGame() {
      if (hero.y < groundY || hero.vy < 0) {
        hero.vy += 0.3;
        hero.y += hero.vy;
        if (hero.y > groundY) {
          hero.y = groundY;
          hero.vy = 0;
          jumpEffect = false;
        }
      }
      if (jumpSignal && hero.y === groundY) {
        const currentTime = Date.now();
        const timeSinceLastJump = currentTime - lastJumpTime;
        let jumpForce = hero.jumpForce;
        if (timeSinceLastJump < 500) { // Nếu nhảy trong vòng 500ms sau lần nhảy trước
          jumpForce *= 1.5; // Tăng lực nhảy lên 1.5 lần
        }
        hero.vy = jumpForce;
        hero.y += hero.vy;
        jumpSignal = false;
        lastJumpTime = currentTime;
        jumpTextVisible = true;
        jumpEffect = true;
        setTimeout(() => { jumpTextVisible = false; }, 800);
      }
      obstacles.forEach(obstacle => {
        obstacle.x -= 3;
      });
      obstacles = obstacles.filter(ob => ob.x + ob.width > 0);
      gameScore += 1;
    }

    function drawGame() {
      gameCtx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);
      gameCtx.fillStyle = "#654321";
      gameCtx.fillRect(0, groundY + 50, gameCanvas.width, gameCanvas.height - groundY - 50);
      if (robotImg.complete) {
        gameCtx.drawImage(robotImg, hero.x, hero.y - hero.height, hero.width, hero.height);
      } else {
        gameCtx.fillStyle = "blue";
        gameCtx.fillRect(hero.x, hero.y - hero.height, hero.width, hero.height);
      }
      if (jumpEffect) {
        gameCtx.fillStyle = "yellow";
        gameCtx.fillRect(hero.x, hero.y, hero.width, 10); // Hiệu ứng vệt sáng dưới chân
      }
      if (jumpTextVisible) {
        gameCtx.fillStyle = "purple";
        gameCtx.font = "30px Arial";
        gameCtx.fillText("NHAY", hero.x + hero.width/2 - 20, hero.y - hero.height - 10);
      }
      obstacles.forEach(obstacle => {
        if (treeImg.complete) {
          gameCtx.drawImage(treeImg, obstacle.x, obstacle.y - obstacle.height, obstacle.width, obstacle.height);
        } else {
          gameCtx.fillStyle = "red";
          gameCtx.fillRect(obstacle.x, obstacle.y - obstacle.height, obstacle.width, obstacle.height);
        }
      });
      gameCtx.fillStyle = "black";
      gameCtx.font = "20px Arial";
      gameCtx.fillText("Điểm: " + gameScore, 10, 30);
    }

    function checkCollision() {
      for (let obstacle of obstacles) {
        if (
          hero.x < obstacle.x + obstacle.width &&
          hero.x + hero.width > obstacle.x &&
          hero.y - hero.height < obstacle.y &&
          hero.y > obstacle.y - obstacle.height
        ) {
          gameOver = true;
          handleGameOver(gameScore);
        }
      }
    }

    function gameLoop() {
      if (!gameOver) {
        updateGame();
        drawGame();
        checkCollision();
        requestAnimationFrame(gameLoop);
      }
    }

    setInterval(() => {
      const obstacle = {
        x: gameCanvas.width,
        y: groundY + 50,
        width: 50,
        height: Math.random() * 50 + 30
      };
      obstacles.push(obstacle);
    }, 3000);

    const startButton = document.getElementById('startButton');
    startButton.addEventListener('click', () => {
      startButton.style.display = "none";
      gameLoop();
    });

    // Phần bảng xếp hạng
    function saveScore(score, name) {
      let scores = JSON.parse(localStorage.getItem('scores')) || [];
      scores.push({ name, score });
      scores.sort((a, b) => b.score - a.score);
      scores = scores.slice(0, 5); // Giữ top 5
      localStorage.setItem('scores', JSON.stringify(scores));
    }

    function displayLeaderboard() {
      const scores = JSON.parse(localStorage.getItem('scores')) || [];
      const leaderboardList = document.getElementById('leaderboardList');
      leaderboardList.innerHTML = '';
      scores.forEach((entry, index) => {
        const li = document.createElement('li');
        li.textContent = `${index + 1}. ${entry.name} - ${entry.score}`;
        leaderboardList.appendChild(li);
      });
    }

    function handleGameOver(score) {
      const scores = JSON.parse(localStorage.getItem('scores')) || [];
      const highestScore = scores.length > 0 ? scores[0].score : 0;
      if (score > highestScore) {
        const name = prompt("Chúc mừng! Bạn đã phá vỡ kỷ lục. Nhập tên của bạn:");
        if (name) {
          saveScore(score, name);
        } else {
          saveScore(score, "Người chơi");
        }
      } else {
        saveScore(score, "Người chơi");
      }
      displayLeaderboard();
      alert("Game Over! Điểm: " + score);
      document.location.reload();
    }

    displayLeaderboard();
  </script>
</body>
</html>
